const express = require('express');
const router = express.Router();

// declare axios for making http requests
const axios = require('axios');

/* GET api listing. */
router.get('/', (req, res) => {
  res.send('api works');
});

// Get all posts
router.get('/posts', (req, res) => {

  //Get the list of domains
  axios.get('http://www.malwaredomainlist.com/mdlcsv.php')
    .then(posts => {
      var data = posts.data.toString().split(/","|\r\n"|",/);
      // res.status(200).json(data);

      var malware = {
        phishing: [],
        exploit: [],
        trojan: [],
        other: []
      }

      //Create object for each ip and sort by category (malware, phishing, etc)
      //Format of csv:
      //Date added | url | ip | reverse lookup | description | owner | ASN | not sure | country
      for(var i = 0; i < data.length; i+=10) {
        // console.log(data[i])
        if(!data[i]) break;

        var site = {
          date: data[i],
          url: data[i+1],
          ip: data[i+2],
          parsedip: data[i+2].match(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/i)[0],
          revlookup: data[i+3],
          description: data[i+4],
          owner: data[i+5],
          asn: data[i+6],
          number: data[i+7],
          country: data[i+8]
        }

        if(site.description.search(/phish/i)) {
          malware.phishing.push(site);
        } else if(site.description.search(/exploit/i)) {
          malware.exploit.push(site);
        } else if(site.description.search(/trojan/i)) {
          malware.trojan.push(site);
        } else {
          malware.other.push(site);
        }
      }
      // console.log(categories);
      res.status(200).json(malware);
    })
    .catch(error => {
      res.status(500).send(error)
    });
});

module.exports = router;
